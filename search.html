<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Search - Wave</title>
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="/logo/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg" />
    <link rel="shortcut" href="/logo/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png" />
    <link rel="manifest" href="/logo/site.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200,0..1,0" />
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/desktop.css">
</head>
<body class="subpage">
    <header class="subpage-header">
        <a href="/home" class="back-link icon-link">
            <span class="material-symbols-outlined">arrow_back_ios_new</span>
        </a>
        <h1>Search</h1>
    </header>

    <main class="subpage-content search-container">
        <div class="search-bar">
            <span class="material-symbols-outlined">search</span>
            <input type="text" id="search-input" placeholder="Search for stations..." autocomplete="off" autofocus disabled>
        </div>

        <div id="search-results" >
             <p id="loading-message">Loading station database...</p>
             <p id="initial-message" style="display:none;">Start typing to find your favorite stations.</p>
        </div>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const loadingMessage = document.getElementById('loading-message');
            const initialMessage = document.getElementById('initial-message');
            let allStreams = [];

            async function initializeSearch() {
                const storedStations = localStorage.getItem('radioStations');

                if (storedStations) {
                    try {
                        allStreams = JSON.parse(storedStations);
                    } catch (error) {
                        console.error('Error parsing stations from localStorage:', error);
                        allStreams = [];
                    }
                }

                if (allStreams.length === 0) {
                    try {
                        console.log('No local data found. Fetching from API...');
                        const response = await fetch('/api/getStations');
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        allStreams = await response.json();
                        
                        localStorage.setItem('radioStations', JSON.stringify(allStreams));
                    } catch (error) {
                        console.error('Failed to fetch stations:', error);
                        allStreams = [];
                    }
                }
                
                if (allStreams.length > 0) {
                    loadingMessage.style.display = 'none';
                    initialMessage.style.display = 'block';
                    searchInput.disabled = false;
                    searchInput.focus();
                } else {
                    loadingMessage.textContent = 'Failed to load stations. Please try again later.';
                }
            }

            const renderResults = (results) => {
                searchResultsContainer.innerHTML = '';
                if (results.length === 0) {
                    searchResultsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 50px 0; font-size: 0.85rem; ">No stations found.</p>';
                    return;
                }

                const list = document.createElement('div');
                list.className = 'channel-list';
                results.forEach(stream => {
                    const item = document.createElement('div');
                    item.className = 'channel-list-item';
                    
                    item.innerHTML = `
                        <div class="channel-info-left">
                            <img src="${stream.logo}" alt="${stream.name} Logo" class="channel-logo" onerror="this.src='/logo/favicon.svg';">
                            <span class="channel-name">${stream.name}</span>
                        </div>
                        <div class="channel-info-right">
                            <span class="material-symbols-outlined">sensors</span>
                        </div>`;

                    item.addEventListener('click', () => {
                        window.location.href = `/home?play=${encodeURIComponent(stream.name.replace(/\s+/g, '-'))}`;
                    });
                    list.appendChild(item);
                });
                searchResultsContainer.appendChild(list);
            };

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                initialMessage.style.display = 'none';
                if (query.length > 1) {
                    const filteredStreams = allStreams.filter(stream => stream.name.toLowerCase().includes(query));
                    renderResults(filteredStreams);
                } else {
                    searchResultsContainer.innerHTML = '';
                    if (query.length === 0) {
                        initialMessage.style.display = 'block';
                    }
                }
            });

            initializeSearch();
        });
</script>
</body>
</html>
